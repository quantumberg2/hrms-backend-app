<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\USER\source\HRMS\hrms-backend-app\HRMS Application\BusinessLogic\Implements\LeaveTrackingImp.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using HRMS_Application.Authorization;
using HRMS_Application.BusinessLogic.Interface;
using HRMS_Application.DTO;
using HRMS_Application.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace HRMS_Application.BusinessLogic.Implements
{
    public class LeaveTrackingImp : ILeaveTracking
    {
        private readonly HRMSContext _hrmsContext;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private readonly IJwtUtils _jwtUtils;
        private List&lt;string&gt;? dToken;
        private int? _decodedToken;
        public LeaveTrackingImp(HRMSContext hrmscontext, IHttpContextAccessor httpContextAccessor, IJwtUtils jwtUtils)
        {
            _hrmsContext = hrmscontext;
            _httpContextAccessor = httpContextAccessor;
            _jwtUtils = jwtUtils;
        }
        private void DecodeToken()
        {
            var token = _httpContextAccessor.HttpContext?.Request.Headers[&quot;Authorization&quot;].ToString().Replace(&quot;Bearer &quot;, &quot;&quot;);
            if (string.IsNullOrEmpty(token))
            {
                dToken = null;
            }
            else
            {
                var userId = _jwtUtils.ValidateJwtToken(token);
                if (userId.HasValue)
                {
                    var userDetails = _hrmsContext.EmployeeCredentials.FirstOrDefault(e =&gt; e.Id == userId.Value);
                    if (userDetails != null)
                    {
                        _decodedToken = userDetails.Id;
                        dToken = userDetails.UserRolesJs.Select(ur =&gt; ur.Roles.Name).ToList();
                    }
                    else
                    {
                        dToken = null;
                    }
                }
            }
        }

        public async Task&lt;IEnumerable&lt;LeaveTracking&gt;&gt; GetAllAsync()
        {
            var result = await (from row in _hrmsContext.LeaveTrackings
                                where row.IsActive == 1
                                select row).ToListAsync();
            return result;
        }

        public async Task&lt;LeaveTracking&gt; GetByIdAsync(int id)
        {
            var res = (from row in _hrmsContext.LeaveTrackings
                       where row.Id == id &amp;&amp; row.IsActive == 1
                       select row).FirstOrDefault();
            return res;
        }

        public async Task&lt;LeaveTracking&gt; CreateAsync(LeaveTracking leaveTracking, int empCredentialId)
        {
            DecodeToken();
            leaveTracking.EmpCredentialId = empCredentialId;

            
            await _hrmsContext.LeaveTrackings.AddAsync(leaveTracking);
            await _hrmsContext.SaveChangesAsync(_decodedToken);

            return leaveTracking;
        }


        public async Task&lt;LeaveTracking&gt; UpdateAsync(LeaveTracking leaveTracking)
        {
             DecodeToken();

            _hrmsContext.LeaveTrackings.Update(leaveTracking);
            await _hrmsContext.SaveChangesAsync(_decodedToken);
            return leaveTracking;
        }



        public async Task&lt;LeaveTracking&gt; UpdateLeaveAsync(int id, string newStatus)
        {
            var leaveTracking = await (from row in _hrmsContext.LeaveTrackings
                                       where row.Id == id
                                       select row).FirstOrDefaultAsync();

            if (leaveTracking != null)
            {
                leaveTracking.Status = newStatus;

                await _hrmsContext.SaveChangesAsync(); 
            }
            return leaveTracking;
        }

        public async Task&lt;bool&gt; DeleteAsync(int id)
        {
            DecodeToken();
            var leaveTracking = await _hrmsContext.LeaveTrackings.FindAsync(id);
            if (leaveTracking == null)
            {
                return false;
            }

            _hrmsContext.LeaveTrackings.Remove(leaveTracking);
            await _hrmsContext.SaveChangesAsync(_decodedToken);
            return true;
        }
        public async Task&lt;List&lt;LeaveApprovalDTO&gt;&gt; GetLeavesByStatusAsync(string status)
        {
            var leaves = await (from leave in _hrmsContext.LeaveTrackings
                                join emp in _hrmsContext.EmployeeDetails on leave.EmpCredentialId equals emp.EmployeeCredentialId
                                join leaveType in _hrmsContext.LeaveTypes on leave.LeaveTypeId equals leaveType.Id
                                where leave.Status == status
                                select new LeaveApprovalDTO
                                {
                                    Id = leave.Id,
                                    EmployeeNumber = emp.EmployeeNumber,
                                    Name = $&quot;{emp.FirstName} {emp.LastName}&quot;,
                                    LeaveType = leaveType.Type, 
                                    StartDate = leave.Startdate ?? DateTime.MinValue,
                                    EndDate = leave.Enddate ?? DateTime.MinValue,
                                    NoofDays = (leave.Enddate.HasValue &amp;&amp; leave.Startdate.HasValue)
                                ? (int)(leave.Enddate.Value - leave.Startdate.Value).TotalDays + 1 
                                : 0
                                }).ToListAsync();

            return leaves;
        }
        public async Task&lt;LeaveSummaryDTO&gt; GetEmployeeLeaveSummaryAsync(int employeeCredentialId)
        {
            var allLeaveDetails = await _hrmsContext.LeaveTrackings
                .Where(l =&gt; l.EmpCredentialId == employeeCredentialId)
                .ToListAsync();

            var totalApprovedCount = allLeaveDetails.Count(l =&gt; l.Status == &quot;Approved&quot;);
            var totalPendingCount  = allLeaveDetails.Count(l =&gt; l.Status == &quot;Pending&quot;);
            var totalRejectedCount = allLeaveDetails.Count(l =&gt; l.Status == &quot;Rejected&quot;);

            
            var leaveAllocations = await _hrmsContext.EmployeeLeaveAllocations
                .Where(e =&gt; e.EmpCredentialId == employeeCredentialId)
                .ToListAsync();

            
            var leaveSummaries = leaveAllocations.Select(allocation =&gt; new LeaveSummaryDTO
            {
                LeaveType = _hrmsContext.LeaveTypes.FirstOrDefault(lt =&gt; lt.Id == allocation.LeaveType)?.Type ?? &quot;Unknown&quot;,
                TotalAllocatedLeaves = allocation.NumberOfLeaves ?? 0,
                ApprovedLeaves = allLeaveDetails
                    .Where(l =&gt; l.LeaveTypeId == allocation.LeaveType &amp;&amp; l.Status == &quot;Approved&quot;)
                    .Sum(l =&gt; (l.Enddate.HasValue &amp;&amp; l.Startdate.HasValue)
                            ? (int)(l.Enddate.Value - l.Startdate.Value).TotalDays + 1
                            : 0),
                PendingLeaves = allLeaveDetails
                    .Where(l =&gt; l.LeaveTypeId == allocation.LeaveType &amp;&amp; l.Status == &quot;Pending&quot;)
                    .Sum(l =&gt; (l.Enddate.HasValue &amp;&amp; l.Startdate.HasValue)
                            ? (int)(l.Enddate.Value - l.Startdate.Value).TotalDays + 1
                            : 0),
                RejectedLeaves = allLeaveDetails
                    .Where(l =&gt; l.LeaveTypeId == allocation.LeaveType &amp;&amp; l.Status == &quot;Rejected&quot;)
                    .Sum(l =&gt; (l.Enddate.HasValue &amp;&amp; l.Startdate.HasValue)
                            ? (int)(l.Enddate.Value - l.Startdate.Value).TotalDays + 1
                            : 0),
                RemainingLeaves = allocation.NumberOfLeaves.HasValue
                    ? allocation.NumberOfLeaves.Value - allLeaveDetails
                        .Where(l =&gt; l.LeaveTypeId == allocation.LeaveType &amp;&amp; l.Status == &quot;Approved&quot;)
                        .Sum(l =&gt; (l.Enddate.HasValue &amp;&amp; l.Startdate.HasValue)
                                ? (int)(l.Enddate.Value - l.Startdate.Value).TotalDays + 1
                                : 0)
                    : 0,
                ApprovedCount = totalApprovedCount,
                PendingCount = totalPendingCount,
                RejectedCount = totalRejectedCount
            }).ToList();

            // Calculate the aggregated totals for all leave types
            var totalApprovedLeaves = leaveSummaries.Sum(x =&gt; x.ApprovedLeaves);
            var totalPendingLeaves = leaveSummaries.Sum(x =&gt; x.PendingLeaves);
            var totalRejectedLeaves = leaveSummaries.Sum(x =&gt; x.RejectedLeaves);
            var totalRemainingLeaves = leaveSummaries.Sum(x =&gt; x.RemainingLeaves);
            var totalAllocatedLeaves = leaveSummaries.Sum(x =&gt; x.TotalAllocatedLeaves);

            
            return new LeaveSummaryDTO
            {
                LeaveType = &quot;All Leave Types&quot;,
                TotalAllocatedLeaves = totalAllocatedLeaves,
                ApprovedLeaves = totalApprovedLeaves,
                PendingLeaves = totalPendingLeaves,
                RejectedLeaves = totalRejectedLeaves,
                RemainingLeaves = totalRemainingLeaves,
                ApprovedCount = totalApprovedCount,
                PendingCount = totalPendingCount,
                RejectedCount = totalRejectedCount,
                LeaveSummaries = leaveSummaries 
            };
        }


        public bool SoftDelete(int id, short isActive)
        {
            var res = (from row in _hrmsContext.LeaveTrackings
                       where row.Id == id
                       select row).FirstOrDefault();
            if (res != null)
            {
                res.IsActive = isActive;
                _hrmsContext.LeaveTrackings.Update(res);
                _hrmsContext.SaveChanges();
                return true;

            }
            return false;
        }

        public async Task&lt;LeaveTracking&gt; ApllyLeaveBehalf(LeaveTracking leaveTracking, int empCredentialId)
        {
            DecodeToken();
            leaveTracking.EmpCredentialId = empCredentialId;

     
            await _hrmsContext.LeaveTrackings.AddAsync(leaveTracking);
            await _hrmsContext.SaveChangesAsync(_decodedToken);

            return leaveTracking;
        }
        public List&lt;LeavePendingDTO&gt; GetPendingLeaves(int employeeCredentialId)
        {
            var pendingLeaves = (from leave in _hrmsContext.LeaveTrackings
                                 join empCred in _hrmsContext.EmployeeCredentials on leave.EmpCredentialId equals empCred.Id
                                 join empDetail in _hrmsContext.EmployeeDetails on empCred.Id equals empDetail.EmployeeCredentialId
                                 join leaveType in _hrmsContext.LeaveTypes on leave.LeaveTypeId equals leaveType.Id
                                 where leave.Status == &quot;Pending&quot; &amp;&amp; empCred.Id == employeeCredentialId
                                 select new LeavePendingDTO
                                 {
                                     id = leave.Id,
                                     employeecredentialId = empCred.Id,
                                     Name = empDetail.FirstName + &quot; &quot; + empDetail.LastName,
                                     LeaveType = leaveType.Type,
                                     managername = _hrmsContext.EmployeeDetails
                                        .Where(mgr =&gt; mgr.EmployeeCredentialId == empDetail.ManagerId)
                                        .Select(mgr =&gt; mgr.FirstName + &quot; &quot; + mgr.LastName).FirstOrDefault(),
                                     Reason = leave.ReasonForLeave,
                                     StartDate = leave.Startdate,
                                     EndDate = leave.Enddate,
                                     Applieddate = leave.AppliedDate,
                                     NoofDays = (leave.Enddate != null &amp;&amp; leave.Startdate != null)
                                        ? (leave.Enddate.Value - leave.Startdate.Value).Days + 1
                                        : 0
                                 }).ToList();

                                   return pendingLeaves;
        }
        
            public List&lt;LeavePendingDTO&gt; GetHistoryLeaves(int employeeCredentialId)
            {
                             var pendingLeaves = (from leave in _hrmsContext.LeaveTrackings
                                 join empCred in _hrmsContext.EmployeeCredentials on leave.EmpCredentialId equals empCred.Id
                                 join empDetail in _hrmsContext.EmployeeDetails on empCred.Id equals empDetail.EmployeeCredentialId
                                 join leaveType in _hrmsContext.LeaveTypes on leave.LeaveTypeId equals leaveType.Id
                                 where (leave.Status == &quot;Rejected&quot; || leave.Status == &quot;Withdrawn&quot; || leave.Status == &quot;Approved&quot;)
                                       &amp;&amp; empCred.Id == employeeCredentialId
                                 select new LeavePendingDTO
                                 {
                                     id = leave.Id,
                                     employeecredentialId = empCred.Id,
                                     Name = empDetail.FirstName + &quot; &quot; + empDetail.LastName,
                                     LeaveType = leaveType.Type,
                                     Reason = leave.ReasonForLeave,
                                     status = leave.Status,
                                     StartDate = leave.Startdate,
                                     EndDate = leave.Enddate,
                                     Applieddate = leave.AppliedDate,
                                     NoofDays = (leave.Enddate != null &amp;&amp; leave.Startdate != null)
                                        ? (leave.Enddate.Value - leave.Startdate.Value).Days + 1
                                        : 0
                                 }).ToList();

                            return pendingLeaves;
            }
            public async Task&lt;LeaveTracking&gt; UpdateLeaveAsyncchanges(int employeeCredentialId, int id, string newStatus)
            {
                 var leaveTracking = await _hrmsContext.LeaveTrackings
                .FirstOrDefaultAsync(lt =&gt; lt.EmpCredentialId == employeeCredentialId &amp;&amp; lt.Id == id);

                 if (leaveTracking != null)
                 {
                    leaveTracking.Status = newStatus;
                    await _hrmsContext.SaveChangesAsync();
                 }

            return leaveTracking;
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,119,1],[18,9,18,10,1],[19,13,19,40,1],[20,13,20,56,1],[21,13,21,34,1],[22,9,22,10,1],[24,9,24,10,1],[25,13,25,126,1],[26,13,26,45,1],[27,13,27,14,1],[28,17,28,31,1],[29,13,29,14,1],[31,13,31,14,0],[32,17,32,64,0],[33,17,33,37,0],[34,17,34,18,0],[35,21,35,114,0],[36,21,36,45,0],[37,21,37,22,0],[38,25,38,56,0],[39,25,39,71,0],[39,71,39,84,0],[39,84,39,95,0],[40,21,40,22,0],[42,21,42,22,0],[43,25,43,39,0],[44,21,44,22,0],[45,17,45,18,0],[46,13,46,14,0],[47,9,47,10,1],[50,9,50,10,1],[51,13,53,59,1],[54,13,54,27,0],[55,9,55,10,0],[58,9,58,10,1],[59,13,61,53,1],[62,13,62,24,0],[63,9,63,10,0],[66,9,66,10,1],[67,13,67,27,1],[68,13,68,61,1],[71,13,71,71,1],[72,13,72,64,0],[74,13,74,34,0],[75,9,75,10,0],[79,9,79,10,1],[80,14,80,28,1],[82,13,82,63,1],[83,13,83,64,0],[84,13,84,34,0],[85,9,85,10,0],[90,9,90,10,1],[91,13,93,74,1],[95,13,95,39,0],[96,13,96,14,0],[97,17,97,50,0],[99,17,99,55,0],[100,13,100,14,0],[101,13,101,34,0],[102,9,102,10,0],[105,9,105,10,1],[106,13,106,27,1],[107,13,107,81,1],[108,13,108,39,0],[109,13,109,14,0],[110,17,110,30,0],[113,13,113,63,0],[114,13,114,64,0],[115,13,115,25,0],[116,9,116,10,0],[118,9,118,10,1],[119,13,134,50,1],[136,13,136,27,0],[137,9,137,10,0],[139,9,139,10,1],[140,13,142,32,1],[144,13,144,65,0],[144,65,144,87,0],[144,87,144,89,0],[145,13,145,65,0],[145,65,145,86,0],[145,86,145,88,0],[146,13,146,65,0],[146,65,146,87,0],[146,87,146,89,0],[149,13,151,32,0],[154,13,154,72,0],[154,72,159,33,0],[159,33,159,96,0],[159,96,160,31,0],[160,31,162,32,0],[162,32,164,33,0],[164,33,164,95,0],[164,95,165,31,0],[165,31,167,32,0],[167,32,169,33,0],[169,33,169,96,0],[169,96,170,31,0],[170,31,172,32,0],[172,32,175,37,0],[175,37,175,100,0],[175,100,176,35,0],[176,35,178,36,0],[178,36,183,14,0],[183,14,183,25,0],[186,13,186,63,0],[186,63,186,79,0],[186,79,186,81,0],[187,13,187,62,0],[187,62,187,77,0],[187,77,187,79,0],[188,13,188,63,0],[188,63,188,79,0],[188,79,188,81,0],[189,13,189,64,0],[189,64,189,81,0],[189,81,189,83,0],[190,13,190,64,0],[190,64,190,86,0],[190,86,190,88,0],[193,13,205,15,0],[206,9,206,10,0],[210,9,210,10,1],[211,13,213,53,1],[214,13,214,29,0],[215,13,215,14,0],[216,17,216,41,0],[217,17,217,57,0],[218,17,218,44,0],[219,17,219,29,0],[222,13,222,26,0],[223,9,223,10,0],[226,9,226,10,1],[227,13,227,27,1],[228,13,228,61,1],[231,13,231,71,1],[232,13,232,64,0],[234,13,234,34,0],[235,9,235,10,0],[237,9,237,10,1],[238,13,259,46,1],[261,36,261,57,0],[262,9,262,10,0],[265,13,265,14,1],[266,30,286,46,1],[288,29,288,50,0],[289,13,289,14,0],[291,13,291,14,1],[292,18,293,103,1],[295,18,295,44,0],[296,18,296,19,0],[297,21,297,54,0],[298,21,298,59,0],[299,18,299,19,0],[301,13,301,34,0],[302,9,302,10,0]]);
    </script>
  </body>
</html>