<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Users\USER\source\HRMS\hrms-backend-app\HRMS Application\Controllers\EmpDetailsController.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using HRMS_Application.BusinessLogic.Interface;
using HRMS_Application.Authorization;

using HRMS_Application.Models;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using HRMS_Application.DTO;
using HRMS_Application.GlobalSearch;
using System.IdentityModel.Tokens.Jwt;

namespace HRMS_Application.Controllers
{
    [Route(&quot;api/[controller]&quot;)]
    [ApiController]
    public class EmpDetailsController : ControllerBase
    {
        private readonly IEmpDetails _Empdetails;
        private readonly ILogger&lt;EmpDetailsController&gt; _logger;


        public EmpDetailsController(IEmpDetails EmpDetails, ILogger&lt;EmpDetailsController&gt; logger)
        {
            _Empdetails = EmpDetails;
            _logger = logger;
        }

        [HttpGet]
        [Authorize(new[] { &quot;Admin&quot;,&quot;Developer&quot; })]
        public List&lt;EmployeeDetail&gt; GetAllEmpDetails()
        {
            _logger.LogInformation(&quot;Get all department method started&quot;);
            var dept = _Empdetails.GetAllUser();
            return dept;
        }
        [HttpGet(&quot;GetById&quot;)]
        [AllowAnonymous]
        public EmployeeDetail GetById(int id)
        {
           
            var status = _Empdetails.GetById(id);
            return status;
        }

        [HttpPost(&quot;insertEmployees&quot;)]
        [Authorize(new[] { &quot;Admin&quot; })]
        public async Task&lt;IActionResult&gt; InsertEmployee([FromBody] EmployeeDetail employeeDetail)
        {
            if (employeeDetail == null)
            {
                return BadRequest(&quot;Employee details are required.&quot;);
            }

            try
            {
                // Extract the JWT token from the Authorization header
                var token = HttpContext.Request.Headers[&quot;Authorization&quot;].ToString().Replace(&quot;Bearer&quot;, &quot;&quot;).Trim();
                if (string.IsNullOrEmpty(token))
                {
                    return Unauthorized(&quot;Authorization token is missing or invalid.&quot;);
                }

                // Decode the JWT token to get the company ID
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(token);

                var companyIdClaim = jwtToken.Claims.FirstOrDefault(claim =&gt; claim.Type == &quot;CompanyId&quot;);
                if (companyIdClaim == null)
                {
                    return Unauthorized(&quot;Company ID not found in token.&quot;);
                }

                // Parse the company ID from the claim
                if (!int.TryParse(companyIdClaim.Value, out int companyId))
                {
                    return BadRequest(&quot;Invalid Company ID in token.&quot;);
                }

                // Call the service to insert the employee
                string result = await _Empdetails.InsertEmployeeAsync(employeeDetail, companyId);

                if (result.Contains(&quot;already in use&quot;))
                {
                    return Conflict(result); // Return 409 Conflict if email already exists
                }

                return Ok(result); // Return 200 OK if employee is inserted successfully
            }
            catch (Exception ex)
            {
                // Log the exception if needed
                return StatusCode(500, $&quot;Internal server error: {ex.Message}&quot;);
            }
        }

        [HttpPut(&quot;UpdateAll/{id}&quot;)]
        [Authorize(new[] { &quot;Admin&quot; })]
        // [Route(&quot;UpdateAll&quot;)]
        public async Task&lt;EmployeeDetail&gt; UpdateEmployeeDetails(int id, int? depId, string? fname, string? mname, string? lname, int? positionid, string? Designation, string? Email, int? employeecredentialId, string? EmployeeNumber, int? requsetCompanyId)
        {
            _logger.LogInformation(&quot;Update Employeedetails method started&quot;);
            var status = await _Empdetails.UpdateEmployeeDetail(id,depId,fname,mname,lname,positionid,Designation,Email,employeecredentialId,EmployeeNumber,requsetCompanyId);
            return status;
        }

        [HttpDelete(&quot;{id}&quot;)]
        [Authorize(new[] { &quot;Admin&quot; })]
        public async Task&lt;bool&gt; DeleteEmpDetails(int id)
        {
            _logger.LogInformation(&quot;Delete method started&quot;);
            var status = await _Empdetails.DeleteEmployeeDetail(id);
            return status;
        }

        [HttpPut(&quot;SoftDelete&quot;)]
        [Authorize(new[] { &quot;Admin&quot; })]

        public bool SoftDelete(int id, short isActive)
        {
            _logger.LogInformation(&quot;Soft update Employee details method started&quot;);
            var res = _Empdetails.SoftDelete(id, isActive);
            return res;

        }
        [HttpGet(&quot;EmployeeInfo&quot;)]
        public ActionResult&lt;IEnumerable&lt;EmployeeView&gt;&gt; GetAllEmployees()
        {
            var employees = _Empdetails.GetAllEmployees();

            return Ok(employees);
        }
        [HttpGet(&quot;getdetails/{employeeCredentialId}&quot;)]
        public async Task&lt;IActionResult&gt; GetEmployeeInfo(int employeeCredentialId)
        {
            var employeeInfo = await _Empdetails.GetEmployeeInfoAsync(employeeCredentialId);

            if (employeeInfo == null)
            {
                return NotFound(&quot;Employee with the given credential ID not found.&quot;);
            }

            return Ok(employeeInfo);
        }
        [HttpGet(&quot;personaldetails/{employeeCredentialId}&quot;)]
        public async Task&lt;IActionResult&gt; GetEmployeePersonalInfo(int employeeCredentialId)
        {
            var employeePersonalInfo = await _Empdetails.GetEmployeePersonalInfoAsync(employeeCredentialId);

            if (employeePersonalInfo == null)
            {
                return NotFound(&quot;Employee personal information not found for the given credential ID.&quot;);
            }

            return Ok(employeePersonalInfo);
        }
        [HttpGet(&quot;addressdetails/{employeeCredentialId}&quot;)]
        public async Task&lt;IActionResult&gt; GetEmployeeAddressInfo(int employeeCredentialId)
        {
            var employeeAddressInfo = await _Empdetails.GetEmployeeAddressInfoAsync(employeeCredentialId);

            if (employeeAddressInfo == null)
            {
                return NotFound(&quot;Employee address information not found for the given credential ID.&quot;);
            }

            return Ok(employeeAddressInfo);
        }
        [HttpGet(&quot;accountdetails/{employeeCredentialId}&quot;)]
        public async Task&lt;IActionResult&gt; GetEmployeeAccountInfo(int employeeCredentialId)
        {
            var accountInfo = await _Empdetails.GetEmployeeAccountInfoAsync(employeeCredentialId);

            if (accountInfo == null)
            {
                return NotFound(&quot;Employee account information not found for the given credential ID.&quot;);
            }

            return Ok(accountInfo);
        }

        [HttpGet(&quot;EmployeeSearch/&quot;)]

        public IActionResult Get([FromQuery] GlobalsearchEmp globalsearch)
        {
            var model = _Empdetails.GetFilters(globalsearch);

            return Ok(model);
        }

        [HttpPut(&quot;updatedetails&quot;)]
        public async Task&lt;IActionResult&gt; UpdateEmployeeInfo([FromBody] UpdateEmployeeInfoDTO updateEmployeeInfo)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            var result = await _Empdetails.UpdateEmployeeInfoAsync(updateEmployeeInfo);

            if (!result)
            {
                return NotFound(&quot;Employee with given credential ID not found.&quot;);
            }

            return Ok(&quot;Employee information updated successfully.&quot;);
        }
        [HttpPut(&quot;PersonalDetails&quot;)]
        public async Task&lt;IActionResult&gt; UpdateEmployeePersonalInfo([FromBody] EmpPersonalInfoDTO empPersonalInfoDTO)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            var result = await _Empdetails.UpdateEmployeepersonalInfoAsync(empPersonalInfoDTO);

            if (!result)
            {
                return NotFound(&quot;Employee with given credential ID not found.&quot;);
            }

            return Ok(&quot;Employee information updated successfully.&quot;);
        }
        [HttpPut(&quot;AddressDetail&quot;)]
        public async Task&lt;IActionResult&gt; UpdateEmployeeAddressInfo([FromBody] AddressInfoDTO addressInfo)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            var result = await _Empdetails.UpdateEmployeeAddresslInfoAsync(addressInfo);

            if (!result)
            {
                return NotFound(&quot;Employee with given credential ID not found.&quot;);
            }

            return Ok(&quot;Employee information updated successfully.&quot;);
        }
        [HttpPut(&quot;AccountDetail&quot;)]
        public async Task&lt;IActionResult&gt; UpdateEmployeeAccountInfo([FromBody] AccountDetail accountDetail)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }/**/

            var result = await _Empdetails.UpdateEmployeeAccountInfoAsync(accountDetail);

            if (!result)
            {
                return NotFound(&quot;Employee with given credential ID not found.&quot;);
            }

            return Ok(&quot;Employee information updated successfully.&quot;);
        }
        [HttpGet(&quot;GetEmployeeShiftAndLeaveStats&quot;)]
        public IActionResult GetEmployeeShiftAndLeaveStats()
        {
            try
            {
                // Extract the JWT token from the Authorization header
                var token = HttpContext.Request.Headers[&quot;Authorization&quot;].ToString().Replace(&quot;Bearer&quot;, &quot;&quot;).Trim();
                if (string.IsNullOrEmpty(token))
                {
                    return Unauthorized(&quot;Authorization token is missing or invalid.&quot;);
                }

                // Decode the JWT token to get the empCredentialId
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(token);

                // Extract the &quot;UserId&quot; claim from the token
                var empCredentialClaim = jwtToken.Claims.FirstOrDefault(claim =&gt; claim.Type == &quot;UserId&quot;);
                if (empCredentialClaim == null)
                {
                    return Unauthorized(&quot;UserId not found in token.&quot;);
                }

                // Parse the empCredentialId from the claim
                if (!int.TryParse(empCredentialClaim.Value, out int empCredentialId))
                {
                    return BadRequest(&quot;Invalid UserId in token.&quot;);
                }

                var stats = _Empdetails.GetEmployeeShiftAndLeaveStats(empCredentialId);

                return Ok(stats);
            }
            catch (Exception ex)
            {
                return StatusCode(500, $&quot;Internal server error: {ex.Message}&quot;);
            }
        }

    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[21,9,21,98,1],[22,9,22,10,1],[23,13,23,38,1],[24,13,24,30,1],[25,9,25,10,1],[30,9,30,10,1],[31,13,31,73,1],[32,13,32,49,1],[33,13,33,25,1],[34,9,34,10,1],[38,9,38,10,1],[40,13,40,50,1],[41,13,41,27,1],[42,9,42,10,1],[47,9,47,10,1],[48,13,48,40,1],[49,13,49,14,0],[50,17,50,69,0],[54,13,54,14,1],[56,17,56,114,1],[57,17,57,49,0],[58,17,58,18,0],[59,21,59,87,0],[63,17,63,61,0],[64,17,64,60,0],[66,17,66,78,0],[66,78,66,103,0],[66,103,66,105,0],[67,17,67,44,0],[68,17,68,18,0],[69,21,69,75,0],[73,17,73,76,0],[74,17,74,18,0],[75,21,75,71,0],[79,17,79,98,0],[81,17,81,55,0],[82,17,82,18,0],[83,21,83,45,0],[86,17,86,35,0],[88,13,88,33,1],[89,13,89,14,1],[91,17,91,80,1],[93,9,93,10,1],[99,9,99,10,1],[100,13,100,77,1],[101,13,101,175,1],[102,13,102,27,1],[103,9,103,10,1],[108,9,108,10,1],[109,13,109,61,1],[110,13,110,69,1],[111,13,111,27,1],[112,9,112,10,1],[118,9,118,10,1],[119,13,119,83,1],[120,13,120,60,1],[121,13,121,24,1],[123,9,123,10,1],[126,9,126,10,1],[127,13,127,59,1],[129,13,129,34,1],[130,9,130,10,1],[133,9,133,10,1],[134,13,134,93,1],[136,13,136,38,1],[137,13,137,14,0],[138,17,138,85,0],[141,13,141,37,1],[142,9,142,10,1],[145,9,145,10,1],[146,13,146,109,1],[148,13,148,46,1],[149,13,149,14,0],[150,17,150,105,0],[153,13,153,45,1],[154,9,154,10,1],[157,9,157,10,1],[158,13,158,107,1],[160,13,160,45,1],[161,13,161,14,0],[162,17,162,104,0],[165,13,165,44,1],[166,9,166,10,1],[169,9,169,10,1],[170,13,170,99,1],[172,13,172,37,1],[173,13,173,14,0],[174,17,174,104,0],[177,13,177,36,1],[178,9,178,10,1],[183,9,183,10,1],[184,13,184,62,1],[186,13,186,30,1],[187,9,187,10,1],[191,9,191,10,1],[192,13,192,37,1],[193,13,193,14,0],[194,17,194,47,0],[197,13,197,88,1],[199,13,199,25,1],[200,13,200,14,1],[201,17,201,81,1],[204,13,204,69,0],[205,9,205,10,1],[208,9,208,10,1],[209,13,209,37,1],[210,13,210,14,0],[211,17,211,47,0],[214,13,214,96,1],[216,13,216,25,1],[217,13,217,14,0],[218,17,218,81,0],[221,13,221,69,1],[222,9,222,10,1],[225,9,225,10,1],[226,13,226,37,1],[227,13,227,14,0],[228,17,228,47,0],[231,13,231,89,1],[233,13,233,25,1],[234,13,234,14,0],[235,17,235,81,0],[238,13,238,69,1],[239,9,239,10,1],[242,9,242,10,1],[243,13,243,37,1],[244,13,244,14,0],[245,17,245,47,0],[248,13,248,90,1],[250,13,250,25,1],[251,13,251,14,0],[252,17,252,81,0],[255,13,255,69,1],[256,9,256,10,1],[259,9,259,10,1],[261,13,261,14,1],[263,17,263,114,1],[264,17,264,49,0],[265,17,265,18,0],[266,21,266,87,0],[270,17,270,61,0],[271,17,271,60,0],[274,17,274,82,0],[274,82,274,104,0],[274,104,274,106,0],[275,17,275,48,0],[276,17,276,18,0],[277,21,277,71,0],[281,17,281,86,0],[282,17,282,18,0],[283,21,283,67,0],[286,17,286,88,0],[288,17,288,34,0],[290,13,290,33,1],[291,13,291,14,1],[292,17,292,80,1],[294,9,294,10,1]]);
    </script>
  </body>
</html>